<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>歐大的投資報表</title>
    <!-- 載入 React 與相關庫 -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@500;700&family=Noto+Sans+TC:wght@400;500;700;900&display=swap');

        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #f8fafc;
            color: #1e293b;
        }

        .font-mono-data {
            font-family: 'JetBrains Mono', monospace;
        }

        /* 3D 按鈕樣式 - 全域 14px */
        .btn-3d-full {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            padding: 4px 4px;
            background-color: #eab308; /* amber-500 */
            color: #0f172a;
            font-weight: 900;
            font-size: 14px; 
            border-radius: 6px;
            border-bottom: 3px solid #a16207;
            transition: all 0.1s;
            text-transform: uppercase;
            box-shadow: 0 2px 4px -1px rgb(0 0 0 / 0.1);
            line-height: 1.2;
        }

        .btn-3d-full.clickable:hover {
            background-color: #fbbf24;
        }

        .btn-3d-full.clickable:active {
            border-bottom-width: 0px;
            transform: translateY(3px);
            box-shadow: none;
        }

        /* 隱藏捲軸 */
        ::-webkit-scrollbar { width: 4px; height: 4px; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }

        @keyframes pulse-red {
            0%, 100% { background-color: #ef4444; }
            50% { background-color: #f87171; }
        }
        .animate-pulse-red {
            animation: pulse-red 2s infinite;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useCallback, useMemo, useRef } = React;

        const VERSION = "v3.9.0";

        const App = () => {
            const [data, setData] = useState([]);
            const [headers, setHeaders] = useState([]);
            const [loading, setLoading] = useState(true);
            const [refreshing, setRefreshing] = useState(false);
            const [error, setError] = useState(null);
            const [currentTime, setCurrentTime] = useState(new Date());
            const [topStats, setTopStats] = useState({ 
                timeValue: '0.0', 
                futureIndex: '0.0',
                pointsChange: '0.0',
                percentChange: '0.0%'
            });
            
            const [isAlerting, setIsAlerting] = useState(false);
            const [lastStopTimestamp, setLastStopTimestamp] = useState(0);
            const [isAudioInitialized, setIsAudioInitialized] = useState(false);
            const audioRef = useRef(new Audio('https://actions.google.com/sounds/v1/alarms/alarm_clock_ringing_beeps.ogg'));

            const SHEET_ID = '1Ysw95KCFw-sHDUntrzsg7zCWPsiAyIIHJ1Yg69pKuKk';
            const GID = '103299629';
            const RANGE = 'C2:O14'; 
            const CSV_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/export?format=csv&gid=${GID}&range=${RANGE}`;

            const fetchData = useCallback(async (isAuto = false) => {
                if (isAuto) setRefreshing(true);
                else setLoading(true);
                
                try {
                    const response = await fetch(`${CSV_URL}&t=${Date.now()}`);
                    const text = await response.text();
                    const rawRows = parseCSV(text);
                    
                    if (rawRows.length >= 2) {
                        const globalRow = rawRows[0];       
                        const originalHeaders = rawRows[1]; 
                        const originalData = rawRows.slice(2); 

                        const tvIdx = originalHeaders.findIndex(h => h.trim().includes('時間價值'));
                        const fiIdx = originalHeaders.findIndex(h => h.trim().includes('期貨指數'));

                        setTopStats({
                            timeValue: tvIdx !== -1 ? (originalData[0]?.[tvIdx] || '0.0') : '0.0',
                            futureIndex: fiIdx !== -1 ? (originalData[0]?.[fiIdx] || '0.0') : '0.0',
                            pointsChange: globalRow[1] || '0', 
                            percentChange: globalRow[2] || '0%' 
                        });

                        const filteredHeaders = originalHeaders.filter((_, idx) => idx !== tvIdx && idx !== fiIdx);
                        const filteredData = originalData.map(row => 
                            row.filter((_, idx) => idx !== tvIdx && idx !== fiIdx)
                        );

                        setHeaders(filteredHeaders);
                        setData(filteredData);
                        setError(null);
                    }
                } catch (err) {
                    setError('連線異常');
                } finally {
                    setLoading(false);
                    setRefreshing(false);
                }
            }, [CSV_URL]);

            useEffect(() => {
                fetchData();
                const syncTimer = setInterval(() => fetchData(true), 30000);
                const clockTimer = setInterval(() => setCurrentTime(new Date()), 1000);
                const initAudio = () => {
                    audioRef.current.play().then(() => {
                        audioRef.current.pause();
                        setIsAudioInitialized(true);
                        window.removeEventListener('click', initAudio);
                    }).catch(() => {});
                };
                window.addEventListener('click', initAudio);
                return () => { clearInterval(syncTimer); clearInterval(clockTimer); };
            }, [fetchData]);

            const hasExtremeRatio = useMemo(() => {
                const ratioIdx = headers.findIndex(h => {
                    const clean = h.trim().toUpperCase();
                    return clean.includes('買權比值') || clean.includes('比值平衡');
                });
                if (ratioIdx === -1) return false;
                return data.some(row => {
                    const val = parseFloat(row[ratioIdx]);
                    return !isNaN(val) && (val < 0.35 || val > 0.65);
                });
            }, [data, headers]);

            useEffect(() => {
                if (hasExtremeRatio && (Date.now() - lastStopTimestamp > 60000)) {
                    setIsAlerting(true);
                    audioRef.current.play().catch(() => {});
                } else {
                    setIsAlerting(false);
                    audioRef.current.pause();
                }
            }, [hasExtremeRatio, lastStopTimestamp]);

            const parseCSV = (text) => {
                const lines = text.split(/\r?\n/);
                return lines.filter(line => line.trim() !== '').map(line => {
                    const result = [];
                    let cur = ''; let inQuote = false;
                    for (let i = 0; i < line.length; i++) {
                        const char = line[i];
                        if (char === '"' && line[i + 1] === '"') { cur += '"'; i++; }
                        else if (char === '"') inQuote = !inQuote;
                        else if (char === ',' && !inQuote) { result.push(cur); cur = ''; }
                        else cur += char;
                    }
                    result.push(cur);
                    return result;
                });
            };

            const getLinkUrl = (name) => {
                if (!name) return null;
                const cleanName = name.trim();
                if (cleanName === "雲熙(主)" || cleanName === "文文(主)") return null;
                const mapping = {
                    "示範帳號(主)": "f4dd324c-5a64-499d-a53d-b133d65e3b58",
                    "聯發哥(主)": "f4dd324c-5a64-499d-a53d-b133d65e3b58",
                    "歐大_凱基": "61cbea15-89e2-caeb-681a-c6f05d0a526b",
                    "大帳號(主)": "dc27f55f-4fa1-79c8-3436-beedaf4ec5c6",
                    "gary-lan(主)": "dc27f55f-4fa1-79c8-3436-beedaf4ec5c6",
                    "獨孤求敗_元富": "8efb9e56-5035-10f0-7d87-6be2a33f354a",
                    "軒偉(主)": "8efb9e56-5035-10f0-7d87-6be2a33f354a",
                    "Earvin(主)": "f125983f-e03b-d7b8-be80-58a13690bb12"
                };
                return mapping[cleanName] ? `https://remotedesktop.google.com/access/session/${mapping[cleanName]}` : `https://www.google.com/search?q=${encodeURIComponent(cleanName)}`;
            };

            const getRatioRedStyle = (val) => {
                const num = parseFloat(val);
                if (isNaN(num)) return "";
                if (num >= 0.4 && num <= 0.6) return "";
                let dist = num < 0.4 ? 0.4 - num : num - 0.6;
                if (dist > 0.3) return "bg-red-800 text-white font-black";
                if (dist > 0.2) return "bg-red-600 text-white font-bold";
                if (dist > 0.1) return "bg-red-400 text-white font-bold";
                return "bg-red-200 text-red-900";
            };

            const getMarginStyle = (val) => {
                const num = parseFloat(val.toString().replace('%', ''));
                if (isNaN(num) || num > 40) return "";
                if (num <= 10) return "bg-green-800 text-white font-black shadow-inner";
                if (num <= 20) return "bg-green-600 text-white font-bold shadow-sm";
                if (num <= 30) return "bg-green-400 text-green-950 font-bold";
                return "bg-green-200 text-green-900";
            };

            const getCellStyles = (header, val) => {
                if (!val) return "";
                const cleanHeader = header.trim().toUpperCase();
                if (cleanHeader.includes('更新時間') && val.includes('斷線')) return "bg-red-600 text-white animate-pulse-red font-bold shadow-inner";
                if (cleanHeader.includes('買權比值') || cleanHeader.includes('比值平衡')) return getRatioRedStyle(val);
                if (cleanHeader.includes('剩餘比率') || cleanHeader.includes('剩餘比例')) return getMarginStyle(val);
                return "";
            };

            const getValByHeader = (row, headerName) => {
                const idx = headers.findIndex(h => h.trim().toUpperCase().includes(headerName.toUpperCase()));
                return idx !== -1 ? row[idx] : "0";
            };

            return (
                <div className="flex flex-col min-h-screen select-none overflow-x-hidden p-0 sm:p-2 bg-slate-50">
                    {/* 頁首看板 - 全部 14px & 數據置中 */}
                    <div className="max-w-[1400px] mx-auto w-full mb-0.5 sm:mb-2 shadow-sm border-b border-slate-200 overflow-hidden flex flex-col sm:flex-row">
                        <div className="bg-[#eab308] px-3 py-1.5 sm:p-2 flex-1 flex items-center justify-between sm:justify-start">
                            <h1 className="text-[14px] font-black italic tracking-tighter text-slate-900 uppercase">歐大的投資報表</h1>
                            <div className="sm:hidden text-[12px] font-mono font-bold text-slate-800">{currentTime.toLocaleTimeString()}</div>
                        </div>
                        {/* 數據看板置中調整：使用 justify-center 或 justify-evenly */}
                        <div className="bg-[#1e293b] text-white px-3 py-1 sm:p-2 flex gap-8 items-center justify-center sm:justify-center sm:flex-1">
                            <div className="text-center flex flex-col items-center">
                                <div className="text-[12px] text-slate-400 font-bold uppercase leading-none mb-0.5">時間價值</div>
                                <div className="font-mono-data text-[14px] font-bold text-emerald-400 leading-none">{topStats.timeValue}</div>
                            </div>
                            <div className="text-center flex flex-col items-center">
                                <div className="text-[12px] text-slate-400 font-bold uppercase leading-none mb-0.5">期貨指數</div>
                                <div className="flex items-center gap-1 leading-none">
                                    <span className="font-mono-data text-[14px] font-bold text-emerald-400">{topStats.futureIndex}</span>
                                    <span className={`text-[14px] font-bold ${parseFloat(topStats.pointsChange) >= 0 ? 'text-red-500' : 'text-green-500'}`}>
                                        {parseFloat(topStats.pointsChange) > 0 ? `+${topStats.pointsChange}` : topStats.pointsChange}
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>

                    {/* 警報區塊 - 14px */}
                    {isAlerting && (
                        <div className="max-w-[1400px] mx-auto w-full mb-0.5 bg-red-600 text-white px-2 py-1 rounded-sm text-center font-black text-[14px] animate-pulse shadow-md flex items-center justify-center gap-2" onDoubleClick={() => setLastStopTimestamp(Date.now())}>
                            <span>⚠️ 極端警報</span>
                            <button className="text-[12px] bg-white text-red-600 px-1 py-0.5 rounded font-bold uppercase leading-none">點兩下暫停</button>
                        </div>
                    )}

                    {/* 電腦版表格佈局 - 14px */}
                    <div className="hidden lg:block max-w-[1400px] mx-auto w-full bg-white shadow-lg rounded-xl overflow-hidden border border-slate-200">
                        <div className="overflow-x-auto">
                            <table className="text-center w-full">
                                <thead>
                                    <tr className="bg-[#0f172a] text-slate-300">
                                        {headers.map((h, i) => (
                                            <th key={i} className="px-4 py-2 text-[14px] font-black uppercase tracking-wider">{h}</th>
                                        ))}
                                    </tr>
                                </thead>
                                <tbody>
                                    {data.map((row, rIdx) => {
                                        const isLastRow = rIdx === data.length - 1;
                                        return (
                                            <tr key={rIdx} className={`${isLastRow ? 'bg-slate-100 font-bold' : 'hover:bg-slate-50'} transition-colors`}>
                                                {row.map((cell, cIdx) => {
                                                    const isName = cIdx === 0;
                                                    const cleanH = headers[cIdx].trim().toUpperCase();
                                                    const isDeltaCol = cleanH.includes("總DELTA值") || cleanH.includes("DELTA");
                                                    const link = isName ? getLinkUrl(cell) : null;
                                                    const specialStyle = getCellStyles(headers[cIdx], cell);
                                                    const isNegative = !isDeltaCol && typeof cell === 'string' && (cell.includes('-') || (cell.startsWith('(') && cell.endsWith(')')));
                                                    
                                                    return (
                                                        <td key={cIdx} className={`p-0 ${specialStyle}`}>
                                                            {isName && !isLastRow ? (
                                                                <div className="p-1">
                                                                    <a href={link || "#"} target={link ? "_blank" : "_self"} rel="noopener noreferrer" 
                                                                       className="btn-3d-full !text-[14px] clickable py-1">
                                                                        {cell} {link && <span className="ml-1 opacity-40 text-[12px]">↗</span>}
                                                                    </a>
                                                                </div>
                                                            ) : (
                                                                <div className={`px-2 py-1.5 text-[14px] font-bold font-mono-data 
                                                                    ${isDeltaCol ? ( (parseFloat(cell) > 10 || parseFloat(cell) < -10) ? 'text-red-600' : 'text-black') : (isNegative ? 'text-red-500' : (specialStyle.includes('text-white') ? 'text-white' : 'text-black'))}`}>
                                                                    {cell || '0'}
                                                                </div>
                                                            )}
                                                        </td>
                                                    );
                                                })}
                                            </tr>
                                        );
                                    })}
                                </tbody>
                            </table>
                        </div>
                    </div>

                    {/* 手機版卡片佈局 - 極度壓縮且全部 14px */}
                    <div className="lg:hidden flex flex-col gap-0.5 px-0.5 pb-6">
                        {data.map((row, rIdx) => {
                            const isLastRow = rIdx === data.length - 1;
                            
                            if (isLastRow) return (
                                <div key={rIdx} className="bg-slate-900 text-white p-2 rounded shadow-lg border-t-2 border-amber-500 mt-1">
                                    <div className="text-[14px] font-black uppercase text-amber-500 mb-1 text-center border-b border-slate-800 pb-0.5">總績效 SUMMARY</div>
                                    <div className="grid grid-cols-1 gap-y-0">
                                        {headers.slice(3).map((h, i) => (
                                            <div key={i} className="flex justify-between items-center border-b border-slate-800 py-0.5">
                                                <span className="text-[14px] text-slate-500 font-bold">{h}</span>
                                                <span className={`font-mono-data text-[14px] font-black ${row[i+3]?.includes('-') ? 'text-red-400' : 'text-emerald-400'}`}>{row[i+3] || '0'}</span>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            );

                            const colUpdate = getValByHeader(row, "更新時間");
                            const colRatio = getValByHeader(row, "買權比值") || getValByHeader(row, "比值平衡");
                            const colDelta = getValByHeader(row, "總DELTA值") || getValByHeader(row, "DELTA");
                            const colProfitAmt = getValByHeader(row, "獲利金額");
                            const colProfitRate = getValByHeader(row, "獲利率");
                            const colMarginAmt = getValByHeader(row, "保證金金額") || getValByHeader(row, "保證金餘額");
                            const colRemainRate = getValByHeader(row, "剩餘比率") || getValByHeader(row, "剩餘比例");
                            const colAsset = getValByHeader(row, "資產");
                            const colInitialAsset = getValByHeader(row, "起始資產");
                            const colPoints = getValByHeader(row, "總點數");

                            return (
                                <div key={rIdx} className="bg-white border-b border-slate-200 overflow-hidden shadow-sm">
                                    {/* 標題按鈕 14px */}
                                    <div className="px-1 py-0.5 bg-[#0f172a]">
                                        {(() => {
                                            const link = getLinkUrl(row[0]);
                                            return (
                                                <a href={link || "#"} target={link ? "_blank" : "_self"} rel="noopener noreferrer"
                                                   className="btn-3d-full !text-[14px] justify-start gap-2 px-3 py-1 clickable">
                                                    <span className="opacity-40 font-mono text-[10px] font-black italic">No.{rIdx + 1}</span>
                                                    <span className="truncate">{row[0]}</span>
                                                    {link && <span className="opacity-40 ml-auto text-[12px]">↗</span>}
                                                </a>
                                            );
                                        })()}
                                    </div>
                                    
                                    {/* 數據網格 - 全域 14px 且行高縮到極致 */}
                                    <div className="px-2 py-0.5 grid grid-cols-2 gap-x-2 bg-white">
                                        
                                        <div className="col-span-1 flex justify-between items-center h-5 border-b border-slate-50">
                                            <span className={`px-1 rounded-sm text-[14px] font-black font-mono-data leading-none ${colUpdate.includes('斷線') ? 'animate-pulse-red text-white bg-red-600' : 'text-red-600'}`}>
                                                {colUpdate.includes('斷線') ? '斷線' : '時間'}
                                            </span>
                                            <span className="text-[14px] font-mono-data text-slate-500 truncate ml-1">{colUpdate.replace('斷線','')}</span>
                                        </div>
                                        <div className={`col-span-1 flex justify-between items-center px-1 rounded-sm h-5 border-b border-slate-50 ${getRatioRedStyle(colRatio)}`}>
                                            <span className="text-[14px] font-bold">比值</span>
                                            <span className="text-[14px] font-black font-mono-data">{colRatio}</span>
                                        </div>

                                        <div className="flex justify-between items-center border-b border-slate-50 h-5">
                                            <span className="text-[14px] text-slate-400 font-bold">Delta</span>
                                            <span className={`text-[14px] font-mono-data ${(parseFloat(colDelta) > 10 || parseFloat(colDelta) < -10) ? 'text-red-600 font-bold' : 'text-black'}`}>{colDelta}</span>
                                        </div>
                                        <div className="flex justify-between items-center border-b border-slate-50 h-5">
                                            <span className="text-[14px] text-slate-400 font-bold">獲利</span>
                                            <span className={`text-[14px] font-black font-mono-data ${colProfitAmt.includes('-') ? 'text-red-500' : 'text-black'}`}>{colProfitAmt}</span>
                                        </div>

                                        <div className="flex justify-between items-center border-b border-slate-50 h-5">
                                            <span className="text-[14px] text-slate-400 font-bold">利率</span>
                                            <span className={`text-[14px] font-black font-mono-data ${colProfitRate.includes('-') ? 'text-red-500' : 'text-black'}`}>{colProfitRate}</span>
                                        </div>
                                        <div className="flex justify-between items-center border-b border-slate-50 h-5">
                                            <span className="text-[14px] text-slate-400 font-bold">保證</span>
                                            <span className="text-[14px] font-bold font-mono-data text-black">{colMarginAmt}</span>
                                        </div>

                                        <div className={`flex justify-between items-center px-1 rounded-sm h-5 ${getMarginStyle(colRemainRate)}`}>
                                            <span className="text-[14px] font-black">剩餘</span>
                                            <span className="text-[14px] font-black font-mono-data">{colRemainRate}</span>
                                        </div>
                                        <div className="flex justify-between items-center border-b border-slate-50 h-5">
                                            <span className="text-[14px] text-slate-400 font-bold">資產</span>
                                            <span className="text-[14px] font-black font-mono-data text-black">{colAsset}</span>
                                        </div>

                                        <div className="flex justify-between items-center border-b border-slate-50 h-5">
                                            <span className="text-[14px] text-slate-400 font-bold">起始</span>
                                            <span className="text-[14px] font-bold font-mono-data text-slate-500">{colInitialAsset}</span>
                                        </div>
                                        <div className="flex justify-between items-center border-b border-slate-50 h-5">
                                            <span className="text-[14px] text-slate-400 font-bold">點數</span>
                                            <span className="text-[14px] font-black font-mono-data text-black">{colPoints}</span>
                                        </div>

                                    </div>
                                </div>
                            );
                        })}
                    </div>
                    
                    <footer className="max-w-[1400px] mx-auto w-full py-2 px-4 flex justify-between items-center opacity-30">
                        <p className="text-[12px] font-black tracking-widest uppercase italic text-slate-900">FINANCIAL TERMINAL</p>
                        <p className="text-[12px] font-mono font-black text-slate-900">{VERSION}</p>
                    </footer>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>