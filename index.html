<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>歐大的投資報表</title>
    <!-- 載入 React 與相關庫 -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Noto+Sans+TC:wght@400;500;700;900&display=swap');

        :root {
            --primary: #0f172a;
            --accent: #eab308;
            --danger: #dc2626;
        }

        /* 核心佈局 */
        html, body {
            margin: 0;
            padding: 0;
            height: auto !important;
            min-height: 100%;
            overflow: visible !important;
            background-color: #f8fafc;
            -webkit-font-smoothing: antialiased;
        }

        body {
            font-family: 'Noto Sans TC', sans-serif;
        }

        .font-mono-data {
            font-family: 'JetBrains Mono', monospace;
        }

        table { border-collapse: separate; border-spacing: 0; }
        th, td { border: 1px solid #e2e8f0 !important; }

        * { -webkit-tap-highlight-color: transparent; }

        ::-webkit-scrollbar { width: 4px; height: 4px; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useCallback, useMemo, useRef } = React;

        const App = () => {
            const [data, setData] = useState([]);
            const [headers, setHeaders] = useState([]);
            const [loading, setLoading] = useState(true);
            const [refreshing, setRefreshing] = useState(false);
            const [error, setError] = useState(null);
            const [currentTime, setCurrentTime] = useState(new Date());
            const [topStats, setTopStats] = useState({ 
                timeValue: '0.0', 
                futureIndex: '0.0',
                pointsChange: '0.0',
                percentChange: '0.0%'
            });
            
            const [isAlerting, setIsAlerting] = useState(false);
            const [lastStopTimestamp, setLastStopTimestamp] = useState(0);
            const [isAudioInitialized, setIsAudioInitialized] = useState(false);
            
            const ALARM_URL = 'https://actions.google.com/sounds/v1/alarms/alarm_clock_ringing_beeps.ogg';
            const audioRef = useRef(new Audio(ALARM_URL));

            // 設定：範圍擴大至 C2 開始以讀取匯總數據
            const SHEET_ID = '1Ysw95KCFw-sHDUntrzsg7zCWPsiAyIIHJ1Yg69pKuKk';
            const GID = '103299629';
            const RANGE = 'C2:O14'; 
            const CSV_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/export?format=csv&gid=${GID}&range=${RANGE}`;

            const fetchData = useCallback(async (isAuto = false) => {
                if (isAuto) setRefreshing(true);
                else setLoading(true);
                
                try {
                    const response = await fetch(`${CSV_URL}&t=${Date.now()}`);
                    if (!response.ok) throw new Error('無法讀取數據');
                    
                    const text = await response.text();
                    const rawRows = parseCSV(text);
                    
                    if (rawRows.length >= 2) {
                        const globalRow = rawRows[0];       // C2:O2 (包含 D2, E2)
                        const originalHeaders = rawRows[1]; // C3:O3
                        const originalData = rawRows.slice(2); // C4:O14

                        const tvIdx = originalHeaders.findIndex(h => h.includes('時間價值'));
                        const fiIdx = originalHeaders.findIndex(h => h.includes('期貨指數'));

                        // 更新頂部數據 (D2 是 index 1, E2 是 index 2 因為範圍從 C 開始)
                        setTopStats({
                            timeValue: tvIdx !== -1 ? (originalData[0] ? originalData[0][tvIdx] : '0.0') : '0.0',
                            futureIndex: fiIdx !== -1 ? (originalData[0] ? originalData[0][fiIdx] : '0.0') : '0.0',
                            pointsChange: globalRow[1] || '0', // D2
                            percentChange: globalRow[2] || '0%' // E2
                        });

                        const filteredHeaders = originalHeaders.filter((_, idx) => idx !== tvIdx && idx !== fiIdx);
                        const filteredData = originalData.map(row => 
                            row.filter((_, idx) => idx !== tvIdx && idx !== fiIdx)
                        );

                        setHeaders(filteredHeaders);
                        setData(filteredData);
                        setError(null);
                    }
                } catch (err) {
                    setError('連線異常');
                } finally {
                    setLoading(false);
                    setRefreshing(false);
                }
            }, [CSV_URL]);

            useEffect(() => {
                fetchData();
                const syncTimer = setInterval(() => fetchData(true), 30000);
                const clockTimer = setInterval(() => setCurrentTime(new Date()), 1000);
                const initAudio = () => {
                    const audio = audioRef.current;
                    audio.play().then(() => {
                        audio.pause();
                        audio.currentTime = 0;
                        setIsAudioInitialized(true);
                        window.removeEventListener('click', initAudio);
                        window.removeEventListener('touchstart', initAudio);
                    }).catch(() => {});
                };
                window.addEventListener('click', initAudio);
                window.addEventListener('touchstart', initAudio);
                return () => { 
                    clearInterval(syncTimer); clearInterval(clockTimer);
                    window.removeEventListener('click', initAudio); window.removeEventListener('touchstart', initAudio);
                };
            }, [fetchData]);

            const hasExtremeRatio = useMemo(() => {
                const ratioIdx = headers.findIndex(h => h.includes('買權比值') || h.includes('比值平衡'));
                if (ratioIdx === -1) return false;
                return data.some(row => {
                    const val = row[ratioIdx];
                    if (!val) return false;
                    const num = parseFloat(val);
                    return !isNaN(num) && (num < 0.35 || num > 0.65);
                });
            }, [data, headers]);

            useEffect(() => {
                const audio = audioRef.current;
                audio.loop = true;
                if (hasExtremeRatio) {
                    const now = Date.now();
                    if (now - lastStopTimestamp > 60000) {
                        setIsAlerting(true);
                        audio.play().catch(() => {});
                    }
                } else {
                    setIsAlerting(false);
                    audio.pause();
                    audio.currentTime = 0;
                }
            }, [hasExtremeRatio, lastStopTimestamp]);

            const handleStopAlert = () => {
                if (isAlerting) {
                    setIsAlerting(false);
                    setLastStopTimestamp(Date.now());
                    audioRef.current.pause();
                    audioRef.current.currentTime = 0;
                }
            };

            const parseCSV = (text) => {
                const lines = text.split(/\r?\n/);
                return lines.filter(line => line.trim() !== '').map(line => {
                    const result = [];
                    let cur = ''; let inQuote = false;
                    for (let i = 0; i < line.length; i++) {
                        const char = line[i];
                        if (char === '"' && line[i + 1] === '"') { cur += '"'; i++; }
                        else if (char === '"') inQuote = !inQuote;
                        else if (char === ',' && !inQuote) { result.push(cur); cur = ''; }
                        else cur += char;
                    }
                    result.push(cur);
                    return result;
                });
            };

            const isNegative = (val) => {
                if (typeof val !== 'string') return false;
                const trimmed = val.trim();
                return trimmed.startsWith('-') || (trimmed.startsWith('(') && trimmed.endsWith(')'));
            };

            const getRatioGradientClass = (header, val) => {
                if (!header || (!header.includes('比值平衡') && !header.includes('買權比值'))) return "";
                const num = parseFloat(val);
                if (isNaN(num) || (num >= 0.4 && num <= 0.6)) return "";
                if (num <= 0.30 || num >= 0.70) return "bg-gradient-to-br from-yellow-500 via-yellow-400 to-yellow-300 text-slate-900 shadow-inner";
                if (num <= 0.35 || num >= 0.65) return "bg-gradient-to-br from-yellow-400 via-yellow-300 to-yellow-200 text-slate-900 shadow-sm";
                return "bg-gradient-to-br from-yellow-200 via-yellow-100 to-yellow-50 text-slate-900";
            };

            const getMarginGradientClass = (header, val) => {
                if (!header || (!header.includes('剩餘比率') && !header.includes('保證金剩餘比例'))) return "";
                const num = parseFloat(val.replace('%', ''));
                if (isNaN(num) || num > 40) return "";
                if (num <= 10) return "bg-gradient-to-br from-red-950 via-red-900 to-red-800 text-white shadow-inner";
                if (num <= 20) return "bg-gradient-to-br from-red-800 via-red-700 to-red-600 text-white shadow-inner";
                if (num <= 30) return "bg-gradient-to-br from-red-600 via-red-500 to-red-400 text-white";
                return "bg-gradient-to-br from-red-300 via-red-200 to-red-100 text-slate-900";
            };

            // 輔助函式：根據數值正負決定顏色 (台股：紅正綠負)
            const getChangeColor = (val) => {
                if (!val) return 'text-white';
                const num = parseFloat(val.toString().replace('%', ''));
                if (num > 0) return 'text-red-500';
                if (num < 0) return 'text-green-500';
                return 'text-white';
            };

            const formatTime = (date) => date.toTimeString().split(' ')[0];

            return (
                <div className="flex flex-col min-h-screen bg-slate-50 select-none overflow-x-hidden" onDoubleClick={handleStopAlert}>
                    {!isAudioInitialized && <div className="fixed top-0 left-0 w-full h-1 bg-yellow-400 z-[100] opacity-50"></div>}

                    {/* 電腦版頂部欄 */}
                    <header className="hidden sm:block sticky top-0 bg-slate-900 text-white shadow-lg z-50 border-b border-slate-800">
                        <div className="flex items-center justify-between px-3 py-1.5 border-b border-white/5">
                            <div className="flex items-center gap-2">
                                <div className={`w-2 h-2 rounded-full ${refreshing ? 'bg-yellow-400 animate-pulse' : 'bg-emerald-500'}`}></div>
                                <span className="text-[9px] font-bold tracking-widest text-slate-400 uppercase">System Active</span>
                            </div>
                            <div className="text-[10px] font-mono font-bold text-slate-300">{formatTime(currentTime)}</div>
                        </div>
                        <div className="flex flex-col md:flex-row md:items-center">
                            <div className="bg-yellow-400 text-slate-900 px-4 py-3 md:py-4 flex-1">
                                <h1 className="text-xl md:text-2xl font-black italic tracking-tighter uppercase">歐大的投資報表</h1>
                            </div>
                            <div className="flex divide-x divide-slate-800 bg-slate-900 border-t border-slate-800 md:border-t-0">
                                <div className="px-4 py-1.5 flex flex-col items-center justify-center text-center">
                                    <span className="text-[8px] text-slate-500 font-bold uppercase mb-1 leading-none">時間價值</span>
                                    <span className="text-emerald-400 font-mono-data font-bold text-xs md:text-base leading-none">{topStats.timeValue}</span>
                                </div>
                                <div className="px-4 py-1.5 flex flex-col items-center justify-center text-center">
                                    <span className="text-[8px] text-slate-500 font-bold uppercase mb-1 leading-none">期貨指數</span>
                                    <div className="flex items-baseline gap-2">
                                        <span className="text-emerald-400 font-mono-data font-bold text-xs md:text-base leading-none">{topStats.futureIndex}</span>
                                        <span className={`text-[11px] font-mono-data font-bold ${getChangeColor(topStats.pointsChange)}`}>{topStats.pointsChange > 0 ? `+${topStats.pointsChange}` : topStats.pointsChange}</span>
                                        <span className={`text-[11px] font-mono-data font-bold ${getChangeColor(topStats.percentChange)}`}>({topStats.percentChange})</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </header>

                    {/* 手機版頂部統計 */}
                    <div className="sm:hidden sticky top-0 z-50 bg-slate-50 pb-1">
                        <div className="space-y-1">
                            <div className="flex justify-between items-center bg-slate-900 px-3 py-1.5 shadow-md">
                                <div className="flex items-center gap-1.5">
                                    <div className={`w-1.5 h-1.5 rounded-full ${refreshing ? 'bg-yellow-400 animate-pulse' : 'bg-emerald-500'}`}></div>
                                    <span className="text-[9px] font-bold text-slate-400 uppercase tracking-tighter">LIVE SYSTEM</span>
                                </div>
                                <div className="text-[10px] font-mono text-slate-300 font-bold">{formatTime(currentTime)}</div>
                            </div>
                            <div className="flex divide-x divide-slate-800 bg-slate-900 overflow-hidden border-b border-slate-800 shadow-md">
                                <div className="flex-1 p-2 flex flex-col items-center justify-center text-center">
                                    <span className="text-[8px] text-slate-500 font-bold uppercase mb-0.5 leading-none">時間價值</span>
                                    <span className="text-emerald-400 font-mono-data font-bold text-xs leading-none">{topStats.timeValue}</span>
                                </div>
                                <div className="flex-[1.5] p-2 flex flex-col items-center justify-center text-center">
                                    <span className="text-[8px] text-slate-500 font-bold uppercase mb-0.5 leading-none">期貨指數 / 漲跌</span>
                                    <div className="flex items-center gap-1.5">
                                        <span className="text-emerald-400 font-mono-data font-bold text-xs leading-none">{topStats.futureIndex}</span>
                                        <span className={`text-[10px] font-mono-data font-bold ${getChangeColor(topStats.pointsChange)}`}>{parseFloat(topStats.pointsChange) > 0 ? `+${topStats.pointsChange}` : topStats.pointsChange}</span>
                                        {/* 手機版漲跌幅加上括號作區別 */}
                                        <span className={`text-[10px] font-mono-data font-bold ${getChangeColor(topStats.percentChange)}`}>({topStats.percentChange})</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <main className={`p-1 sm:p-4 bg-[#f1f5f9] transition-transform`}>
                        {loading && data.length === 0 ? (
                            <div className="flex flex-col items-center justify-center py-20 text-slate-400">
                                <div className="w-8 h-8 border-4 border-slate-200 border-t-yellow-400 rounded-full animate-spin mb-4"></div>
                                <p className="text-xs font-bold uppercase tracking-widest font-mono">Loading Data...</p>
                            </div>
                        ) : error ? (
                            <div className="bg-red-50 border border-red-200 p-6 rounded-xl text-center my-10 max-w-sm mx-auto">
                                <p className="text-red-600 font-bold mb-4">⚠️ 連線異常</p>
                                <button onClick={() => fetchData()} className="px-6 py-2 bg-red-600 text-white rounded-lg text-sm font-bold">重新嘗試</button>
                            </div>
                        ) : (
                            <div className="max-w-7xl mx-auto pb-20">
                                {isAlerting && (
                                    <div className="mb-4 bg-red-600 text-white px-4 py-2 rounded-lg text-center font-bold text-sm animate-pulse flex items-center justify-center gap-2 shadow-xl">
                                        <span>⚠️ 極端警報：數值大偏移</span>
                                        <span className="text-[10px] bg-white text-red-600 px-2 py-0.5 rounded">雙擊暫停音效</span>
                                    </div>
                                )}

                                <div className="hidden lg:block bg-white rounded-xl shadow-xl overflow-hidden border border-slate-200">
                                    <div className="overflow-x-auto">
                                        <table className="w-full text-left">
                                            <thead>
                                                <tr className="bg-slate-900 text-slate-300">
                                                    {headers.map((h, i) => (
                                                        <th key={i} className="px-4 py-3 text-[11px] font-black uppercase tracking-wider text-center border-slate-800">{h}</th>
                                                    ))}
                                                </tr>
                                            </thead>
                                            <tbody className="divide-y divide-slate-100">
                                                {data.map((row, rIdx) => (
                                                    <tr key={rIdx} className="hover:bg-slate-50 transition-colors">
                                                        {row.map((cell, cIdx) => {
                                                            const isNeg = isNegative(cell);
                                                            const isDiscMsg = headers[cIdx].includes('更新時間') && cell.includes('斷線');
                                                            const numVal = parseFloat(cell.replace('%', ''));
                                                            const isRatioHeader = headers[cIdx].includes('買權比值') || headers[cIdx].includes('比值平衡');
                                                            const isAlertExtreme = isRatioHeader && !isNaN(numVal) && (numVal < 0.35 || numVal > 0.65);
                                                            const ratioGradient = getRatioGradientClass(headers[cIdx], cell);
                                                            const marginClass = getMarginGradientClass(headers[cIdx], cell);
                                                            let cellStyle = "px-4 py-2.5 text-xs font-bold font-mono-data text-center ";
                                                            if (isDiscMsg) cellStyle += "bg-red-600 text-white animate-pulse";
                                                            else if (isAlertExtreme) cellStyle += ratioGradient + " text-red-700 ring-2 ring-inset ring-red-600";
                                                            else if (marginClass) cellStyle += marginClass;
                                                            else if (ratioGradient) cellStyle += ratioGradient;
                                                            else if (isNeg) cellStyle += "text-red-500";
                                                            else cellStyle += "text-slate-700";
                                                            return <td key={cIdx} className={cellStyle}>{cell || '0'}</td>;
                                                        })}
                                                    </tr>
                                                ))}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>

                                <div className="lg:hidden grid grid-cols-1 md:grid-cols-2 gap-2">
                                    {data.map((row, rIdx) => (
                                        <div key={rIdx} className="bg-white rounded-lg border border-slate-200 overflow-hidden shadow-sm">
                                            <div className="bg-slate-900 px-3 py-1.5 flex justify-between items-center">
                                                <span className="text-white font-bold text-xs tracking-tight">{row[0]}</span>
                                                <span className="text-[8px] bg-yellow-400 text-slate-900 px-1.5 py-0.5 rounded font-black shrink-0">#{rIdx+1}</span>
                                            </div>
                                            <div className="p-2 grid grid-cols-2 gap-y-1 gap-x-2">
                                                {headers.slice(1).map((h, i) => {
                                                    const cell = row[i+1];
                                                    const isNeg = isNegative(cell);
                                                    const isDiscCell = h.includes('更新時間') && cell.includes('斷線');
                                                    const numVal = parseFloat(cell.replace('%', ''));
                                                    const isRatioHeader = h.includes('買權比值') || h.includes('比值平衡');
                                                    const isAlertExtreme = isRatioHeader && !isNaN(numVal) && (numVal < 0.35 || numVal > 0.65);
                                                    const ratioGradient = getRatioGradientClass(h, cell);
                                                    const marginClass = getMarginGradientClass(h, cell);
                                                    let highlightClass = "";
                                                    let textClass = isNeg ? "text-red-500" : "text-slate-800";
                                                    if (marginClass) {
                                                        highlightClass = marginClass + " rounded";
                                                        if (marginClass.includes('text-white')) textClass = "text-white";
                                                    } else if (isAlertExtreme) {
                                                        highlightClass = ratioGradient + " rounded border-2 border-red-600 shadow-inner";
                                                        textClass = "text-red-700";
                                                    } else if (isDiscCell) {
                                                        highlightClass = "bg-red-600 text-white rounded animate-pulse";
                                                        textClass = "text-white";
                                                    } else if (ratioGradient) {
                                                        highlightClass = ratioGradient + " rounded border border-yellow-400 shadow-sm";
                                                        textClass = "text-slate-900";
                                                    }
                                                    return (
                                                        <div key={i} className={`flex justify-between items-center border-b border-slate-50 py-1 px-1.5 ${highlightClass}`}>
                                                            <span className={`text-[9px] font-bold uppercase truncate max-w-[60px] leading-none tracking-tighter ${highlightClass && textClass === "text-white" ? 'text-white' : 'text-slate-400'}`}>{h}</span>
                                                            <span className={`text-xs font-mono-data font-black leading-none ${textClass}`}>{cell || '0'}</span>
                                                        </div>
                                                    );
                                                })}
                                            </div>
                                        </div>
                                    ))}
                                    <div className="col-span-full py-10 text-center opacity-20">
                                        <p className="text-[9px] font-black tracking-[0.4em] uppercase">END OF STREAM</p>
                                    </div>
                                </div>
                            </div>
                        )}
                    </main>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>