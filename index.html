<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>歐大的投資報表</title>
    <!-- 載入 React 與相關庫 -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@500;700&family=Noto+Sans+TC:wght@400;500;700;900&display=swap');

        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #f1f5f9;
            color: #1e293b;
        }

        .font-mono-data {
            font-family: 'JetBrains Mono', monospace;
        }

        /* 3D 按鈕樣式 */
        .btn-3d-full {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            padding: 8px 4px; /* 手機版預設較扁平 */
            background-color: #eab308; /* amber-500 */
            color: #0f172a;
            font-weight: 900;
            border-radius: 8px;
            border-bottom: 4px solid #a16207; /* darker amber edge */
            transition: all 0.1s;
            text-transform: uppercase;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
        }

        @media (min-width: 768px) {
            .btn-3d-full {
                padding: 10px 4px;
            }
        }

        .btn-3d-full.clickable:hover {
            background-color: #fbbf24;
        }

        .btn-3d-full.clickable:active {
            border-bottom-width: 0px;
            transform: translateY(4px);
            box-shadow: none;
        }

        .btn-3d-no-link {
            cursor: default;
        }

        /* 表格格線微調 */
        table { border-collapse: collapse; width: 100%; }
        th, td { border: 1px solid #e2e8f0; }
        
        /* 隱藏捲軸 */
        ::-webkit-scrollbar { width: 4px; height: 4px; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }

        /* 卡片式佈局陰影 */
        .card-shadow {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useCallback, useMemo, useRef } = React;

        const VERSION = "v1.7.0";

        const App = () => {
            const [data, setData] = useState([]);
            const [headers, setHeaders] = useState([]);
            const [loading, setLoading] = useState(true);
            const [refreshing, setRefreshing] = useState(false);
            const [error, setError] = useState(null);
            const [currentTime, setCurrentTime] = useState(new Date());
            const [topStats, setTopStats] = useState({ 
                timeValue: '0.0', 
                futureIndex: '0.0',
                pointsChange: '0.0',
                percentChange: '0.0%'
            });
            
            const [isAlerting, setIsAlerting] = useState(false);
            const [lastStopTimestamp, setLastStopTimestamp] = useState(0);
            const [isAudioInitialized, setIsAudioInitialized] = useState(false);
            const audioRef = useRef(new Audio('https://actions.google.com/sounds/v1/alarms/alarm_clock_ringing_beeps.ogg'));

            const SHEET_ID = '1Ysw95KCFw-sHDUntrzsg7zCWPsiAyIIHJ1Yg69pKuKk';
            const GID = '103299629';
            const RANGE = 'C2:O14'; 
            const CSV_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/export?format=csv&gid=${GID}&range=${RANGE}`;

            const fetchData = useCallback(async (isAuto = false) => {
                if (isAuto) setRefreshing(true);
                else setLoading(true);
                
                try {
                    const response = await fetch(`${CSV_URL}&t=${Date.now()}`);
                    const text = await response.text();
                    const rawRows = parseCSV(text);
                    
                    if (rawRows.length >= 2) {
                        const globalRow = rawRows[0];       
                        const originalHeaders = rawRows[1]; 
                        const originalData = rawRows.slice(2); 

                        const tvIdx = originalHeaders.findIndex(h => h.includes('時間價值'));
                        const fiIdx = originalHeaders.findIndex(h => h.includes('期貨指數'));

                        setTopStats({
                            timeValue: tvIdx !== -1 ? (originalData[0]?.[tvIdx] || '0.0') : '0.0',
                            futureIndex: fiIdx !== -1 ? (originalData[0]?.[fiIdx] || '0.0') : '0.0',
                            pointsChange: globalRow[1] || '0', 
                            percentChange: globalRow[2] || '0%' 
                        });

                        const filteredHeaders = originalHeaders.filter((_, idx) => idx !== tvIdx && idx !== fiIdx);
                        const filteredData = originalData.map(row => 
                            row.filter((_, idx) => idx !== tvIdx && idx !== fiIdx)
                        );

                        setHeaders(filteredHeaders);
                        setData(filteredData);
                        setError(null);
                    }
                } catch (err) {
                    setError('連線異常');
                } finally {
                    setLoading(false);
                    setRefreshing(false);
                }
            }, [CSV_URL]);

            useEffect(() => {
                fetchData();
                const syncTimer = setInterval(() => fetchData(true), 30000);
                const clockTimer = setInterval(() => setCurrentTime(new Date()), 1000);
                const initAudio = () => {
                    audioRef.current.play().then(() => {
                        audioRef.current.pause();
                        setIsAudioInitialized(true);
                        window.removeEventListener('click', initAudio);
                    }).catch(() => {});
                };
                window.addEventListener('click', initAudio);
                return () => { clearInterval(syncTimer); clearInterval(clockTimer); };
            }, [fetchData]);

            const hasExtremeRatio = useMemo(() => {
                const ratioIdx = headers.findIndex(h => h.includes('買權比值') || h.includes('比值平衡'));
                if (ratioIdx === -1) return false;
                return data.some(row => {
                    const val = parseFloat(row[ratioIdx]);
                    return !isNaN(val) && (val < 0.35 || val > 0.65);
                });
            }, [data, headers]);

            useEffect(() => {
                if (hasExtremeRatio && (Date.now() - lastStopTimestamp > 60000)) {
                    setIsAlerting(true);
                    audioRef.current.play().catch(() => {});
                } else {
                    setIsAlerting(false);
                    audioRef.current.pause();
                }
            }, [hasExtremeRatio, lastStopTimestamp]);

            const parseCSV = (text) => {
                const lines = text.split(/\r?\n/);
                return lines.filter(line => line.trim() !== '').map(line => {
                    const result = [];
                    let cur = ''; let inQuote = false;
                    for (let i = 0; i < line.length; i++) {
                        const char = line[i];
                        if (char === '"' && line[i + 1] === '"') { cur += '"'; i++; }
                        else if (char === '"') inQuote = !inQuote;
                        else if (char === ',' && !inQuote) { result.push(cur); cur = ''; }
                        else cur += char;
                    }
                    result.push(cur);
                    return result;
                });
            };

            const getLinkUrl = (name) => {
                if (name === "雲熙(主)" || name === "文文(主)") return null;
                const mapping = {
                    "示範帳號(主)": "f4dd324c-5a64-499d-a53d-b133d65e3b58",
                    "聯發哥(主)": "f4dd324c-5a64-499d-a53d-b133d65e3b58",
                    "歐大_凱基": "61cbea15-89e2-caeb-681a-c6f05d0a526b",
                    "大帳號(主)": "dc27f55f-4fa1-79c8-3436-beedaf4ec5c6",
                    "gary-lan(主)": "dc27f55f-4fa1-79c8-3436-beedaf4ec5c6",
                    "獨孤求敗_元富": "8efb9e56-5035-10f0-7d87-6be2a33f354a",
                    "軒偉(主)": "8efb9e56-5035-10f0-7d87-6be2a33f354a",
                    "Earvin(主)": "f125983f-e03b-d7b8-be80-58a13690bb12"
                };
                return mapping[name] ? `https://remotedesktop.google.com/access/session/${mapping[name]}` : `https://www.google.com/search?q=${encodeURIComponent(name)}`;
            };

            const getCellStyles = (header, val) => {
                if (!val) return "";
                const num = parseFloat(val.toString().replace('%', ''));
                if (isNaN(num)) return "";
                
                if (header.includes('更新時間') && val.includes('斷線')) return "bg-red-500 text-white animate-pulse";
                if (header.includes('買權比值') || header.includes('比值平衡')) {
                    if (num <= 0.35 || num >= 0.65) return "bg-yellow-400 border-2 border-red-600 text-slate-900";
                    if (num <= 0.38 || num >= 0.62) return "bg-yellow-100";
                }
                return "";
            };

            return (
                <div className="flex flex-col min-h-screen select-none overflow-x-hidden p-0 sm:p-4">
                    {/* 頁首設計 */}
                    <div className="max-w-[1400px] mx-auto w-full mb-2 sm:mb-4 shadow-lg sm:rounded-lg overflow-hidden flex flex-col sm:flex-row">
                        <div className="bg-[#eab308] p-3 sm:p-4 flex-1 flex items-center justify-between sm:justify-start">
                            <h1 className="text-xl sm:text-2xl font-black italic tracking-tighter text-slate-900 uppercase">歐大的投資報表</h1>
                            <div className="sm:hidden text-[10px] font-mono font-bold text-slate-800">{currentTime.toLocaleTimeString()}</div>
                        </div>
                        <div className="bg-[#1e293b] text-white p-3 sm:p-4 flex gap-4 sm:gap-8 items-center justify-between sm:justify-end">
                            <div className="text-center">
                                <div className="text-[9px] sm:text-[10px] text-slate-400 font-bold uppercase mb-0.5 sm:mb-1 leading-none">時間價值</div>
                                <div className="font-mono-data text-base sm:text-xl font-bold text-emerald-400 leading-none">{topStats.timeValue}</div>
                            </div>
                            <div className="text-center">
                                <div className="text-[9px] sm:text-[10px] text-slate-400 font-bold uppercase mb-0.5 sm:mb-1 leading-none">期貨指數</div>
                                <div className="flex items-center gap-1 sm:gap-2 leading-none">
                                    <span className="font-mono-data text-base sm:text-xl font-bold text-emerald-400">{topStats.futureIndex}</span>
                                    <div className="flex flex-col sm:flex-row items-start sm:items-center sm:gap-1">
                                        <span className={`text-[10px] sm:text-xs font-bold ${parseFloat(topStats.pointsChange) >= 0 ? 'text-red-500' : 'text-green-500'}`}>
                                            {parseFloat(topStats.pointsChange) > 0 ? `+${topStats.pointsChange}` : topStats.pointsChange}
                                        </span>
                                        <span className={`text-[10px] sm:text-xs font-bold ${parseFloat(topStats.percentChange) >= 0 ? 'text-red-500' : 'text-green-500'}`}>
                                            ({topStats.percentChange})
                                        </span>
                                    </div>
                                </div>
                            </div>
                            <div className="hidden md:block border-l border-slate-700 pl-4 text-xs font-mono text-slate-400">
                                {currentTime.toLocaleTimeString()}
                            </div>
                        </div>
                    </div>

                    {/* 警報區塊 */}
                    {isAlerting && (
                        <div className="max-w-[1400px] mx-auto w-full mb-4 bg-red-600 text-white px-4 py-2 rounded-lg text-center font-black text-xs sm:text-sm animate-pulse shadow-xl flex items-center justify-center gap-4" onDoubleClick={() => setLastStopTimestamp(Date.now())}>
                            <span>⚠️ 極端警報：數值大偏移</span>
                            <button className="text-[9px] bg-white text-red-600 px-2 py-0.5 rounded uppercase font-bold">雙擊暫停</button>
                        </div>
                    )}

                    {/* 統一數據表格佈局 */}
                    <div className="max-w-[1400px] mx-auto w-full bg-white shadow-2xl rounded-xl overflow-hidden border border-slate-200">
                        <div className="overflow-x-auto">
                            <table className="text-center min-w-[1000px] sm:min-w-full">
                                <thead>
                                    <tr className="bg-[#0f172a] text-slate-300">
                                        {headers.map((h, i) => (
                                            <th key={i} className="px-2 sm:px-3 py-2 sm:py-4 text-[10px] sm:text-[11px] font-black uppercase tracking-wider">{h}</th>
                                        ))}
                                    </tr>
                                </thead>
                                <tbody>
                                    {data.map((row, rIdx) => {
                                        const isLastRow = rIdx === data.length - 1;
                                        return (
                                            <tr key={rIdx} className={`${isLastRow ? 'bg-slate-100 font-bold' : 'hover:bg-slate-50'} transition-colors`}>
                                                {row.map((cell, cIdx) => {
                                                    const isName = cIdx === 0;
                                                    const link = isName ? getLinkUrl(cell) : null;
                                                    const specialStyle = getCellStyles(headers[cIdx], cell);
                                                    const isNegative = typeof cell === 'string' && (cell.includes('-') || (cell.startsWith('(') && cell.endsWith(')')));
                                                    
                                                    return (
                                                        <td key={cIdx} className={`p-0 ${specialStyle}`}>
                                                            {isName && !isLastRow ? (
                                                                <div className="p-0.5 sm:p-1">
                                                                    {link ? (
                                                                        <a href={link} target="_blank" rel="noopener noreferrer" className="btn-3d-full clickable text-[10px] sm:text-xs">
                                                                            {cell} <span className="ml-1 opacity-40 text-[9px] sm:text-[10px]">↗</span>
                                                                        </a>
                                                                    ) : (
                                                                        <div className="btn-3d-full btn-3d-no-link text-[10px] sm:text-xs">
                                                                            {cell}
                                                                        </div>
                                                                    )}
                                                                </div>
                                                            ) : (
                                                                <div className={`px-2 py-1.5 sm:py-3 text-[10px] sm:text-xs font-bold font-mono-data ${isNegative ? 'text-red-500' : 'text-slate-700'} ${isLastRow ? 'text-xs sm:text-sm' : ''}`}>
                                                                    {cell || '0'}
                                                                </div>
                                                            )}
                                                        </td>
                                                    );
                                                })}
                                            </tr>
                                        );
                                    })}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <footer className="max-w-[1400px] mx-auto w-full py-6 sm:py-8 px-4 flex justify-between items-center opacity-40">
                        <p className="text-[10px] font-black tracking-[0.2em] sm:tracking-[0.4em] uppercase">System Live Feed • End of Stream</p>
                        <p className="text-[10px] font-mono font-black text-slate-900">{VERSION}</p>
                    </footer>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>